/*

 eventsource.js
 Available under MIT License (MIT)
 https://github.com/Yaffle/EventSource/
*/
(function(h){function S(){this.codePoint=this.bitsNeeded=0}function y(a){this.withCredentials=!1;this.responseType="";this.status=this.readyState=0;this.responseText=this.statusText="";this.onreadystatechange=this.onprogress=k;this._contentType="";this._xhr=a;this._sendTimeout=0;this._abort=k}function T(a){return a.replace(/[A-Z]/g,function(a){return String.fromCharCode(a.charCodeAt(0)+32)})}function U(a){var d=Object.create(null);a=a.split("\r\n");for(var b=0;b<a.length;b+=1){var c=a[b].split(": "),
e=c.shift(),c=c.join(": ");d[T(e)]=c}this._map=d}function V(){}function W(a){this._headers=a}function X(){}function t(){this._listeners=Object.create(null)}function L(a){w(function(){throw a;},0)}function G(a){this.type=a;this.target=void 0}function Y(a,d){G.call(this,a);this.data=d.data;this.lastEventId=d.lastEventId}function O(a,d){G.call(this,a);this.status=d.status;this.statusText=d.statusText;this.headers=d.headers}function n(a,d){t.call(this);this._close=this.withCredentials=this.readyState=
this.url=this.onerror=this.onmessage=this.onopen=void 0;ca(this,a,d)}function ca(a,d,b){d=String(d);var c=void 0!=b&&!!b.withCredentials,e=M(1E3),f=void 0!=b&&void 0!=b.heartbeatTimeout?P(b.heartbeatTimeout,45E3):M(45E3),r="",g=e,H=!1,l=void 0!=b&&void 0!=b.headers?JSON.parse(JSON.stringify(b.headers)):void 0,A=void 0!=b&&void 0!=b.Transport?b.Transport:void 0!=z&&"withCredentials"in z.prototype||void 0==Z?z:Z,h=!da||void 0!=b&&void 0!=b.Transport?new y(new A):void 0,n=void 0==h?new X:new V,x=void 0,
p=0,u=-1,k="",q="",B="",t="",m=0,v=0,C=0,F=function(b,c,d,f,l){0===u&&(x=l,200===b&&void 0!=d&&fa.test(d)?(u=1,H=!0,g=e,a.readyState=1,b=new O("open",{status:b,statusText:c,headers:f}),a.dispatchEvent(b),N(a,a.onopen,b)):(200!==b?(c&&(c=c.replace(/\s+/g," ")),d="EventSource's response has a status "+b+" "+c+" that is not 200. Aborting the connection."):d="EventSource's response has a Content-Type specifying an unsupported type: "+(void 0==d?"-":d.replace(/\s+/g," "))+". Aborting the connection.",
L(Error(d)),D(),b=new O("error",{status:b,statusText:c,headers:f}),a.dispatchEvent(b),N(a,a.onerror,b)))},J=function(b){if(1===u){for(var c=-1,d=0;d<b.length;d+=1){var l=b.charCodeAt(d);if(10===l||13===l)c=d}d=(-1!==c?t:"")+b.slice(0,c+1);t=(-1===c?t:"")+b.slice(c+1);""!==d&&(H=!0);for(b=0;b<d.length;b+=1)if(l=d.charCodeAt(b),-1===m&&10===l)m=0;else if(-1===m&&(m=0),13===l||10===l){if(0!==m){1===m&&(C=b+1);var c=d.slice(v,C-1),A=d.slice(C+(C<b&&32===d.charCodeAt(C)?1:0),b);"data"===c?(k+="\n",k+=
A):"id"===c?q=A:"event"===c?B=A:"retry"===c?g=e=P(A,e):"heartbeatTimeout"===c&&(f=P(A,f),0!==p&&(E(p),p=w(function(){I()},f)))}if(0===m){if(""!==k&&(r=q,""===B&&(B="message"),c=new Y(B,{data:k.slice(1),lastEventId:q}),a.dispatchEvent(c),"message"===B&&N(a,a.onmessage,c),2===u))break;B=k=""}m=13===l?-1:0}else 0===m&&(v=b,m=1),1===m?58===l&&(C=b+1,m=2):2===m&&(m=3)}},K=function(){if(1===u||0===u){u=-1;0!==p&&(E(p),p=0);p=w(function(){I()},g);g=M(Math.min(16*e,2*g));a.readyState=0;var b=new G("error");
a.dispatchEvent(b);N(a,a.onerror,b)}},D=function(){u=2;void 0!=x&&(x(),x=void 0);0!==p&&(E(p),p=0);a.readyState=2},I=function(){p=0;if(-1!==u)H||void 0==x?(H=!1,p=w(function(){I()},f)):(L(Error("No activity within "+f+" milliseconds. Reconnecting.")),x(),x=void 0);else{H=!1;p=w(function(){I()},f);u=0;B=k="";q=r;t="";m=C=v=0;var a=d;"data:"!==d.slice(0,5)&&"blob:"!==d.slice(0,5)&&""!==r&&(a+=(-1===d.indexOf("?")?"?":"&")+"lastEventId="+encodeURIComponent(r));var b={Accept:"text/event-stream"};if(void 0!=
l)for(var e in l)Object.prototype.hasOwnProperty.call(l,e)&&(b[e]=l[e]);try{n.open(h,F,J,K,a,c,b)}catch(ea){throw D(),ea;}}};a.url=d;a.readyState=0;a.withCredentials=c;a._close=D;I()}var w=h.setTimeout,E=h.clearTimeout,z=h.XMLHttpRequest,Z=h.XDomainRequest,J=h.EventSource,K=h.document,q=h.Promise,v=h.fetch,aa=h.Response,F=h.TextDecoder,ba=h.TextEncoder,D=h.AbortController;void 0==Object.create&&(Object.create=function(a){function d(){}d.prototype=a;return new d});void 0!=q&&void 0==q.prototype["finally"]&&
(q.prototype["finally"]=function(a){return this.then(function(d){return q.resolve(a()).then(function(){return d})},function(d){return q.resolve(a()).then(function(){throw d;})})});if(void 0!=v)var ga=v,v=function(a,d){return q.resolve(ga(a,d))};void 0==D&&(D=function(){this.signal=null;this.abort=function(){}});S.prototype.decode=function(a){function d(a,b,c){if(1===c)return a>=128>>b&&2047>=a<<b;if(2===c)return a>=2048>>b&&55295>=a<<b||a>=57344>>b&&65535>=a<<b;if(3===c)return a>=65536>>b&&1114111>=
a<<b;throw Error();}function b(a,b){if(6===a)return 15<b>>6?3:31<b?2:1;if(12===a)return 15<b?3:2;if(18===a)return 3;throw Error();}for(var c="",e=this.bitsNeeded,f=this.codePoint,r=0;r<a.length;r+=1){var g=a[r];0!==e&&(128>g||191<g||!d(f<<6|g&63,e-6,b(e,f)))&&(e=0,f=65533,c+=String.fromCharCode(f));0===e?(0<=g&&127>=g?(e=0,f=g):192<=g&&223>=g?(e=6,f=g&31):224<=g&&239>=g?(e=12,f=g&15):240<=g&&247>=g?(e=18,f=g&7):(e=0,f=65533),0===e||d(f,e,b(e,f))||(e=0,f=65533)):(e-=6,f=f<<6|g&63);0===e&&(65535>=f?
c+=String.fromCharCode(f):(c+=String.fromCharCode(55296+(f-65535-1>>10)),c+=String.fromCharCode(56320+(f-65535-1&1023))))}this.bitsNeeded=e;this.codePoint=f;return c};var Q;if(!(Q=void 0==F||void 0==ba)){var R;a:{try{R="test"===(new F).decode((new ba).encode("test"),{stream:!0});break a}catch(a){console.log(a)}R=!1}Q=!R}Q&&(F=S);var k=function(){};y.prototype.open=function(a,d){this._abort(!0);var b=this,c=this._xhr,e=1,f=0;this._abort=function(a){0!==b._sendTimeout&&(E(b._sendTimeout),b._sendTimeout=
0);if(1===e||2===e||3===e)e=4,c.onload=k,c.onerror=k,c.onabort=k,c.onprogress=k,c.onreadystatechange=k,c.abort(),0!==f&&(E(f),f=0),a||(b.readyState=4,b.onreadystatechange());e=0};var r=function(){if(1===e){var a=0,d="",f=void 0;if("contentType"in c)a=200,d="OK",f=c.contentType;else try{a=c.status,d=c.statusText,f=c.getResponseHeader("Content-Type")}catch(x){a=0,d="",f=void 0}0!==a&&(e=2,b.readyState=2,b.status=a,b.statusText=d,b._contentType=f,b.onreadystatechange())}},g=function(){r();if(2===e||
3===e){e=3;var a="";try{a=c.responseText}catch(ha){}b.readyState=3;b.responseText=a;b.onprogress()}},h=function(){g();if(1===e||2===e||3===e)e=4,0!==f&&(E(f),f=0),b.readyState=4,b.onreadystatechange()},l=function(){f=w(function(){l()},500);3===c.readyState&&g()};c.onload=h;c.onerror=h;c.onabort=h;"sendAsBinary"in z.prototype||"mozAnon"in z.prototype||(c.onprogress=g);c.onreadystatechange=function(){void 0!=c&&(4===c.readyState?h():3===c.readyState?g():2===c.readyState&&r())};"contentType"in c&&(d+=
(-1===d.indexOf("?")?"?":"&")+"padding=true");c.open(a,d,!0);"readyState"in c&&(f=w(function(){l()},0))};y.prototype.abort=function(){this._abort(!1)};y.prototype.getResponseHeader=function(a){return this._contentType};y.prototype.setRequestHeader=function(a,d){var b=this._xhr;"setRequestHeader"in b&&b.setRequestHeader(a,d)};y.prototype.getAllResponseHeaders=function(){return void 0!=this._xhr.getAllResponseHeaders?this._xhr.getAllResponseHeaders():""};y.prototype.send=function(){if("ontimeout"in
z.prototype||void 0==K||void 0==K.readyState||"complete"===K.readyState){var a=this._xhr;a.withCredentials=this.withCredentials;a.responseType=this.responseType;try{a.send(void 0)}catch(b){throw b;}}else{var d=this;d._sendTimeout=w(function(){d._sendTimeout=0;d.send()},4)}};U.prototype.get=function(a){return this._map[T(a)]};V.prototype.open=function(a,d,b,c,e,f,h){a.open("GET",e);var g=0;a.onprogress=function(){var c=a.responseText.slice(g);g+=c.length;b(c)};a.onreadystatechange=function(){if(2===
a.readyState){var b=a.status,e=a.statusText,f=a.getResponseHeader("Content-Type"),g=a.getAllResponseHeaders();d(b,e,f,new U(g),function(){a.abort()})}else 4===a.readyState&&c()};a.withCredentials=f;a.responseType="text";for(var k in h)Object.prototype.hasOwnProperty.call(h,k)&&a.setRequestHeader(k,h[k]);a.send()};W.prototype.get=function(a){return this._headers.get(a)};X.prototype.open=function(a,d,b,c,e,f,h){var g=new D;a=g.signal;var k=new F;v(e,{headers:h,credentials:f?"include":"same-origin",
signal:a,cache:"no-store"}).then(function(a){var c=a.body.getReader();d(a.status,a.statusText,a.headers.get("Content-Type"),new W(a.headers),function(){g.abort();c.cancel()});return new q(function(a,d){var e=function(){c.read().then(function(c){c.done?a(void 0):(c=k.decode(c.value,{stream:!0}),b(c),e())})["catch"](function(a){d(a)})};e()})})["finally"](function(){c()})};t.prototype.dispatchEvent=function(a){a.target=this;var d=this._listeners[a.type];if(void 0!=d)for(var b=d.length,c=0;c<b;c+=1){var e=
d[c];try{"function"===typeof e.handleEvent?e.handleEvent(a):e.call(this,a)}catch(f){L(f)}}};t.prototype.addEventListener=function(a,d){a=String(a);var b=this._listeners,c=b[a];void 0==c&&(c=[],b[a]=c);for(var b=!1,e=0;e<c.length;e+=1)c[e]===d&&(b=!0);b||c.push(d)};t.prototype.removeEventListener=function(a,d){a=String(a);var b=this._listeners,c=b[a];if(void 0!=c){for(var e=[],f=0;f<c.length;f+=1)c[f]!==d&&e.push(c[f]);0===e.length?delete b[a]:b[a]=e}};Y.prototype=Object.create(G.prototype);O.prototype=
Object.create(G.prototype);var fa=/^text\/event\-stream;?(\s*charset\=utf\-8)?$/i,P=function(a,d){var b=parseInt(a,10);b!==b&&(b=d);return M(b)},M=function(a){return Math.min(Math.max(a,1E3),18E6)},N=function(a,d,b){try{"function"===typeof d&&d.call(a,b)}catch(c){L(c)}},da=void 0!=v&&void 0!=aa&&"body"in aa.prototype;n.prototype=Object.create(t.prototype);n.prototype.CONNECTING=0;n.prototype.OPEN=1;n.prototype.CLOSED=2;n.prototype.close=function(){this.controller.abort();this._close()};n.CONNECTING=
0;n.OPEN=1;n.CLOSED=2;n.prototype.withCredentials=void 0;(function(a){"object"===typeof module&&"object"===typeof module.exports?(a=a(exports),void 0!==a&&(module.exports=a)):"function"===typeof define&&define.amd?define(["exports"],a):a(h)})(function(a){a.EventSourcePolyfill=n;a.NativeEventSource=J;void 0==z||void 0!=J&&"withCredentials"in J.prototype||(a.EventSource=n)})})("undefined"!==typeof window?window:this);
